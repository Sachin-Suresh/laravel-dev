# Understanding the Ksytych Framework

<font color='#7540EE'>

1. [Introduction](#introduction)
1. [Comparing Ksytych and Laravel Directory Structure](#comparing-ksytych-and-laravel-directory-structure)
1. [Mapping Folders in Laravel and Ksytych Framework](#mapping-folders-in-laravel-and-ksytych-framework)
1. [Running Services](#running-services)
1. [Commonly Used Libraries in Kstych Framework](#commonly-used-libraries-in-kstych-framework)

</font>
- - - -

## Introduction

The Ksytych directory structure is inherited from the Laravel application structure, but works based on the single-line command that is executed from the `kstych.sh` shell script file. When you run the `kstych.sh` file that is located within the `framework` directory, the following actions take place:

- The folders `data/custom`, `data/var/lib/mysql`, and `data/etc/letsencrypt` are created in the root directory, i.e., `data` directory.

- The following snippet from the `kstych.sh` script checks if the container that you are running is *podman* or *docker*:

```
COMMAND="podman"
if ! command -v $COMMAND &> /dev/null
then
    COMMAND="docker"
fi
```

- The following single-line command from the script file executes the docker container.

```
$COMMAND run --rm -it --shm-size=2gb \
                --network=kstych-framework \
                --name=kstych-framework \
                -v `pwd`/data/var/lib/mysql:/var/lib/mysql:Z \
                -v `pwd`/data/custom:/home/Kstych/Framework/custom:Z \
                -v `pwd`/data/etc/letsencrypt:/etc/letsencrypt:Z \
                -p 80:80 -p 443:443 \
                -e KSTYCH_LICENSE="$ARG1" -e KSTYCH_DOMAIN="$ARG2" -e KSTYCH_IP="$ARG3" \
      kstych/framework
```

## Comparing Ksytych and Laravel Directory Structure

You can learn more about the [Laravel directory structure](https://laravel.com/docs/8.x/structure) before understanding the Kstych directory structure.

The root directory, i.e., the `data` directory created by the `kstych.sh` script file contains all application data and files in the `custom`, `etc`, and `var` directories that require persistence.

The following tree structure gives an overview of the different directories and sub-directories in the Kstych framework and how it can be compared with the Laravel application structure.

    ðŸ“¦data                             : Root directory
    â”£ ðŸ“‚custom                         : Contains code, configurations & any file uploads
    â”ƒ â”£ ðŸ“‚app                          : Comparable to Laravel `storage/app` directory
    â”ƒ â”ƒ â”£ ðŸ“‚public                     : Comparable to Laravel `storage/app/public` folder
    â”ƒ â”ƒ â”— ðŸ“‚temp                       : Directory used by the application to manage temporary files
    â”ƒ â”ƒ â”ƒ â”£ ðŸ“œkstych-localhost.sh      : Kstych localhost script file
    â”ƒ â”ƒ â”ƒ â”£ ðŸ“œoauth-private.key        : The OAuth private key file
    â”ƒ â”ƒ â”ƒ â”— ðŸ“œoauth-public.key         : The OAuth public key file
    â”ƒ â”£ ðŸ“‚ext                          : Contains custom code extensions
    â”ƒ â”ƒ â”£ ðŸ“‚assets                     : Directory mapped to `/public/custom/*`
    â”ƒ â”ƒ â”£ ðŸ“‚config                     : Custom directory containing Kstych framework configuration files
    â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚lang                     : Contains the framework language files
    â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚models                   : Contains the model configuration files generated by the framework
    â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚modules                  : Contains application module definitions generated by the framework
    â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚seed                     : Seed data auto generated from database CRUD operations (if configured)
    â”ƒ â”ƒ â”ƒ â”— ðŸ“œapp.php
    â”ƒ â”ƒ â”£ ðŸ“‚packages                   : Comparable to Laravel namespace App/Custom
    â”ƒ â”ƒ â”£ ðŸ“‚tests                      : Contains custom test files for the application
    â”ƒ â”ƒ â”— ðŸ“‚views                      : Comparable to Laravel `resources/views/custom` directory
    â”ƒ â”£ ðŸ“œ.env
    â”ƒ â”— ðŸ“œ.gitignore
    â”£ ðŸ“‚etc                            : Used to store SSL certificates
    â”ƒ â”— ðŸ“‚letsencrypt                  : Stores https certificates if configured
    â”£ ðŸ“‚var                            : Stores the MySQL data files & directories
    â”ƒ â”£ ðŸ“‚lib                          : Contains the dynamic data library files
    â”ƒ â”ƒ â”£ ðŸ“‚mysql                      : Contains the MariaDB data files

<img src="../markups/migrate-info-markup.svg">


## Mapping Folders in Laravel and Ksytych Framework

To avoid the issues that you might face in Laravel during (manual) folder configurations, the directories in Ksytych framework is isolated from the Laravel's directory structure.

If you need to see how the core Laravel code files/directories are mapped within the Kstych framework, you can do so by accessing the docker image by following the below steps:

1. Navigate to **Admin**-> **Designer** menu.
1. Click **Commands** option on the left pane, and click the terminal icon.

    <img src="../images/core-laravel.png"/>

1. You can now access the Laravel directories and see their mappings with the Kstych directories. For example, change to the `app` directory, and list the files and directories using `ls -l`. You can see that the `app/Custom` Laravel's directory is mapped to the `/custom/ext/packages` path in the Ksytych framework.

    <img src="../images/app_dir_mapping.png"/>

    Similarly, the `tests` directory in the Laravel is mapped to `/custom/ext/packages` path in the Ksytych framework.

    <img src="../images/tests_dir_mapping.png"/>


## Running Services

The Docker container automatically runs the following services when you start the Kstych framework.

<img src="../markups/running-services.svg">

- **httpd** : port **8080**,**4443** (you may change external ports mapping by editing the `kstych.sh` file)
- **mariadb** : no exposed port outside
- **asterisk** : port **8088**,**8089** used for websocket push notifications and webrtc voice/video conferencing
- **cron** : laravel cron job runs every minute
- **redis** : no exposed ports
- **queue worker** : laravel queue worker that can run 10 parallel queue jobs
- **websocket service** : event based websocket handler that connects to asterisk
- **chromedriver** : google chrome driver for pdf generation, web automation.

To view the status of all the above services, you can navigate to the **Admin**-> **Designer** menu, and click **Commands** on the left pane.

<img src="../images/services_status.png"/>

## Commonly Used Libraries in Kstych Framework

Kstych provides you with some of the most widely used libraries. Let's take a look at some of the scenarios.

**Use Case 1:** To generate PDF from URLs, you can view the `KChromePDF.php` file from the `/home/Kstych/Framework/application/app/Kstych/Browser/` directory.

``` php
<style type="text/css" media="print">
@page {
    size: A4;
    margin: 0;
}
@media print {
    html, body {
        width: 1200px;
        height: 297mm;
    }
}
</style>

$p=new \App\Kstych\Browser\KChromePDF();
$pdf=$p->urlToPdf("https://google.com");

header("Content-type:application/pdf");
header("Content-Disposition:attachment;filename='downloaded.pdf'");
echo $pdf;
```

**<--To discuss other Use cases-->**


